from kivy.app import App
from kivy.uix.floatlayout import FloatLayout
from kivy.uix.button import Button
from kivy.uix.label import Label
from kivy.uix.textinput import TextInput
from kivy.uix.image import Image
from kivy.uix.popup import Popup  # <- Ð²Ð°Ð¶Ð½Ð¾!
from kivy.uix.widget import Widget
from kivy.graphics import Color, Rectangle
from kivy.clock import Clock
import time

# ------------------ ÐŸÐµÑ€ÐµÑ‚Ð°ÑÐºÐ¸Ð²Ð°ÐµÐ¼Ð¾Ðµ Ð¾ÐºÐ½Ð¾ ------------------

class DraggableWindow(FloatLayout):
    def __init__(self, title="ÐžÐºÐ½Ð¾", content=None, taskbar=None, **kwargs):
        super().__init__(**kwargs)
        self.size_hint = (0.7, 0.6)
        self.pos_hint = {"center_x": 0.5, "center_y": 0.6}
        self.taskbar = taskbar

        with self.canvas:
            Color(0.9, 0.9, 0.9, 1)
            self.rect = Rectangle(size=self.size, pos=self.pos)

        self.bind(size=self.update_rect, pos=self.update_rect)

        self.title_bar = Button(
            text=title,
            size_hint=(1, 0.15),
            pos_hint={"x": 0, "top": 1},
            background_color=(0, 0.3, 0.8, 1)
        )
        self.title_bar.bind(on_touch_move=self.move_window)
        self.add_widget(self.title_bar)

        close_btn = Button(
            text="X",
            size_hint=(0.15, 0.15),
            pos_hint={"right": 1, "top": 1},
            background_color=(1, 0, 0, 1)
        )
        close_btn.bind(on_press=self.close_window)
        self.add_widget(close_btn)

        if content:
            content.size_hint = (1, 0.85)
            content.pos_hint = {"x": 0, "y": 0}
            self.add_widget(content)

        if taskbar:
            taskbar.add_window_button(title, self)

    def update_rect(self, *args):
        self.rect.size = self.size
        self.rect.pos = self.pos

    def move_window(self, instance, touch):
        if instance.collide_point(*touch.pos):
            self.x += touch.dx
            self.y += touch.dy

    def close_window(self, instance):
        if self.parent:
            self.parent.remove_widget(self)

# ------------------ ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð·Ð°Ð´Ð°Ñ‡ ------------------

class Taskbar(FloatLayout):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.size_hint = (1, 0.1)
        self.pos_hint = {"x": 0, "y": 0}

        with self.canvas:
            Color(0.2, 0.2, 0.2, 1)
            self.rect = Rectangle(size=self.size, pos=self.pos)

        self.bind(size=self.update_rect, pos=self.update_rect)

        self.clock_label = Label(
            text="",
            size_hint=(0.2, 1),
            pos_hint={"right": 1, "y": 0}
        )
        self.add_widget(self.clock_label)
        Clock.schedule_interval(self.update_clock, 1)

        self.window_buttons = []

    def update_rect(self, *args):
        self.rect.size = self.size
        self.rect.pos = self.pos

    def update_clock(self, dt):
        self.clock_label.text = time.strftime("%H:%M:%S")

    def add_window_button(self, title, window):
        btn = Button(
            text=title,
            size_hint=(0.2, 1),
            pos_hint={"x": 0.2 * len(self.window_buttons), "y": 0}
        )
        btn.bind(on_press=lambda x: self.toggle_window(window))
        self.window_buttons.append(btn)
        self.add_widget(btn)

    def toggle_window(self, window):
        window.opacity = 1 if window.opacity == 0 else 0

# ------------------ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ------------------

class MiniXP(App):
    def build(self):
        root = FloatLayout()

        # ÐžÐ±Ð¾Ð¸ â€” Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð° "xp.jpg"
        try:
            bg = Image(source="xp.jpg", allow_stretch=True, keep_ratio=False)
        except:
            bg = Image()  # Ð¿ÑƒÑÑ‚Ð¾Ðµ, ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ñ„Ð°Ð¹Ð»Ð°
        root.add_widget(bg)

        self.taskbar = Taskbar()
        root.add_widget(self.taskbar)

        # ÐšÐ½Ð¾Ð¿ÐºÐ° ÐŸÑƒÑÐº
        start_btn = Button(
            text="ÐŸÑƒÑÐº",
            size_hint=(0.2, 0.1),
            pos_hint={"x": 0, "y": 0},
            background_color=(0, 0.6, 0, 1)
        )
        start_btn.bind(on_press=self.open_start)
        root.add_widget(start_btn)

        self.root_layout = root
        return root

    def open_window(self, title, content):
        win = DraggableWindow(title=title, content=content, taskbar=self.taskbar)
        self.root_layout.add_widget(win)

    def open_start(self, instance):
        layout = FloatLayout()

        programs = [
            ("ÐœÐ¾Ð¹ ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€", lambda x: self.open_window("ÐœÐ¾Ð¹ ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€", Label(text="Ð”Ð¸ÑÐº C:\\\nAndroid Storage"))),
            ("Ð‘Ð»Ð¾ÐºÐ½Ð¾Ñ‚", lambda x: self.open_window("Ð‘Ð»Ð¾ÐºÐ½Ð¾Ñ‚", TextInput(multiline=True))),
            ("ÐšÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€", lambda x: self.open_window("ÐšÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€", Label(text="2+2=4"))),
            ("Paint", lambda x: self.open_window("Paint", Label(text="Ð Ð¸ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ ÑÐºÐ¾Ñ€Ð¾ ðŸ˜Ž"))),
            ("ÐšÐ¾Ñ€Ð·Ð¸Ð½Ð°", lambda x: self.open_window("ÐšÐ¾Ñ€Ð·Ð¸Ð½Ð°", Label(text="ÐŸÐ¾ÐºÐ° Ð¿ÑƒÑÑ‚Ð¾"))),
        ]

        y = 0.8
        for name, action in programs:
            btn = Button(
                text=name,
                size_hint=(1, 0.18),
                pos_hint={"x": 0, "y": y}
            )
            btn.bind(on_press=action)
            layout.add_widget(btn)
            y -= 0.18

        popup = Popup(title="ÐœÐµÐ½ÑŽ ÐŸÑƒÑÐº", content=layout, size_hint=(0.6, 0.6))
        popup.open()

MiniXP().run()
